PROMPT_TEMPLATE = """
Ты — финансовый ассистент, который анализирует поведение клиента и предлагает персональные push-уведомления.
Твоя цель — помочь клиенту контролировать расходы, формировать сбережения и замечать возможности для дохода.
Используй только предоставленные категории расходов и продукты. Если не хватает данных — делай консервативные рекомендации.

## Контекст:
- Профиль клиента:
  - Имя: {client_name}
  - Статус: {client_status}
  - Возраст: {client_age}
  - Город: {client_city}
  - Средний месячный баланс (KZT): {avg_monthly_balance}

- Сводка за последние 3 месяца:
  - Расходы по категориям:
    {total_transactions}
  - Полученные переводы (IN):
    {total_transfers_in}
  - Переводы другим (OUT):
    {total_transfers_out}

- Топ-4 категорий расходов:
{top4_categories}



- Каталог доступных банковских продуктов:
  1) Карта для путешествий → подходит, если заметные траты на «Путешествия», «Такси», «Отели».
  2) Премиальная карта → для клиентов с высоким балансом/остатком, у кого траты на «Кафе и рестораны», «Косметика и Парфюмерия».
  3) Кредитная карта → для клиентов с активными расходами на «Игры», «Доставка», «Кино» или частыми разнотипными тратами.
  4) Обмен валют → 
     • Подходит, если клиент переводил или получал более 10 000 000 ₸ за период.  
     • Также полезен для клиентов с валютными доходами или активными трансграничными операциями.
  5) Кредит наличными → если расходы превышают баланс или есть большие исходящие переводы.
  6) Депозит Мультивалютный → выгоден клиентам с доходами/переводами в разных валютах.
  7) Депозит Сберегательный → для тех, кто копит и не планирует тратить ближайшее время.
  8) Депозит Накопительный → для клиентов с регулярными расходами, кто хочет откладывать постепенно.
  9) Инвестиции → для тех, у кого остаётся свободный баланс и низкие расходы.
  10) Золотые слитки → вариант для клиентов с высоким доходом и желающих долгосрочно сохранить капитал.

## Задача:
1) Проанализируй расходы относительно доступного баланса и доходов. Обрати внимание на ростовые/аномальные категории.
2) Подбери РОВНО один продукт из каталога, который лучше всего подходит профилю и паттернам трат/переводов,
   и обоснуй выбор кратко (как оффер). Если явного соответствия нет — верни null.

## Формат ответа (строго JSON):
## Формат ответа (строго JSON):
{{
  "product_suggestion": {{
    "name": "продукт",
    "reason": "обоснование"
  }}
}}
"""


def answer(client) -> dict:
  from openai import OpenAI

  top4_str = "\n".join(
    [f"{item['category']}: {item['amount']:,.2f} ₸" for item in client.top4_categories]
  )

  prompt = PROMPT_TEMPLATE.format(client_name=client.name,
                                    client_status=client.status,
                                    client_age=client.age,
                                    client_city=client.city,
                                    avg_monthly_balance=client.avg_monthly_balance_KZT,
                                    total_transactions=client.total_transactions,
                                    total_transfers_in=client.total_transfers_in,
                                    total_transfers_out=client.total_transfers_out,
                                    top4_categories=top4_str)
  
  
  print(prompt)
  client = OpenAI()

  response = client.chat.completions.create(
    model="gpt-4o-mini",   # or "gpt-4o", "gpt-3.5-turbo", etc.
    messages=[
        {"role": "system", "content": "Ты умный ассистент банка."},
        {"role": "user", "content": prompt}
    ],
    temperature=0.3
  )
  result = response.choices[0].message.content
  print(result)